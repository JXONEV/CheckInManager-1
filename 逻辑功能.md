# 逻辑功能

### 老师、管理员登录---统一用id和密码登录
+ request

    登录页面：GET /login

    页面输入：user_id【8位数字】, password【6-18位，数字+大小写字母】
    【前端需要对工号密码格式要求，不为空】

    api：POST /api/users/session
    + Header
    
        Content-Type:application/json

    + Body
    ```
    {
        "user_id": "15331117", 
        "password": "15331117"
    }
    ```

+ response

    - 200  成功登录
        + Header

            Set-Cookie:key=3w4e5r6tyuifcgvhbjnkmlvg

        + Body

            重定向：跳转到登录后的主界面
    
    - 400 用户输入格式错误（前端也需要做输入格式的检查）
        + Header

            Content-Type:application/json

        + Body
        ```
            {
                "message": "empty username or password"
            }
        ```

    - 401 用户登录失败（用户Id或密码错误）
        + Header

            Content-Type:application/json
            
        + Body
        ```
            {
                "message": "incorrect username or password"
            }
        ```

    - 500  服务器
        + Header

            Content-Type:application/json
            
        + Body
        ```
            {
            "message": "哎咧……服务器出错了(><)"
            }
        ```

### 登出
+ request

    api: DELETE /api/users/session

    + HEADERS

        Cookie:key=3w4e5r6tyuifcgvhbjnkmlvg
    
+ response
    - 204  成功登出

    - 401  
        + Header

            Content-Type:application/json

        + Body
        ```
            {
            "message": "登出失败"
            }
        ```

## 老师

+ 若页面url是在非登录状态下请求 302 

        Location: 登录页面（重定向）

+ 若api是在非登录状态下请求  401

    + Header

        Content-Type:application/json
    
    + Body
        ```
        {
            "message": "请先登录"
        }
        ```

### 1.主页面获取所教课程列表

返回课程信息有：课程id 课程名 是否进行 学期 

+ request

    页面 GET /courses

    + HEADERS

        Cookie:key=3w4e5r6tyuifcgvhbjnkmlvg

+ response
    + 200  成功获取列表页面

        ```
        {
            "courses":[
                {
                    "course_id":"1", 
                    "course_name":"数据挖掘",
                    "semester":"2017-2018学年度第二学期",
                    "is_closed":0
                },
                {
                    "course_id":"2", 
                    "course_name":"数值计算",
                    "semester":"2016-2017学年度第一学期",
                    "is_closed":0
                }
            ]
        }
        ```
    
### 2.选择某个课程信息

获取 course_name（课程名）, credit（学分）, semester（学期）, class_time（上课时间）, venue（上课地点）, 学生人数 等课程信息 + 教师姓名(teacher_id,teacher_name)

+ request

    页面 GET /course/{course_id}

    + HEADERS

        Cookie:key=3w4e5r6tyuifcgvhbjnkmlvg

+ response
    + 200  成功获取对应课程页面
        
        ```
        {
            "course_name": "系统设计与分析",
            "course_id": "1234",
            "credit": 2,
            "semester": "2017-2018学年度第一学期",
            "class_time": "周二1-4节课", 
            "venue": "公教楼b栋", 
            "student_num": 100,
            "teacher_id": 1234,
            "teacher_name":"pml"
        }
        ```


### 3.选择某个课程的学生列表 

所有学生的student_id, student_name（如果学生数量很多，前端可以分页显示）

+ request

    页面 GET /course_member/{course_id}

    + HEADERS

        Cookie:key=3w4e5r6tyuifcgvhbjnkmlvg

+ response

    + 200  成功获取学生页面列表
        
        ```
        {
            "course_member":[
                {
                    "student_id":"15331117",
                    "student_name":"王小明"
                },
                {
                    "student_id":"11171533",
                    "student_name":"高恩星"
                }
            ]
        }
        ```

### 4.选择某个课程的查看签到信息

按行显示：签到日期【yyyy-mm-dd hh:mm:ss】 签到人数 未签到人数

+ request

    页面 GET /courses/{course_id}/checkin_history

    + HEADERS

        Cookie:key=3w4e5r6tyuifcgvhbjnkmlvg

+ response

    + 200  成功获取签到历史页面列表
        
        ```
        {
            "checkin_history":[
                {
                    "checkin_id":1231
                    "datetime":"2018-01-03 11:12:23",
                    "checkined":80,
                    "uncheckined":4
                },
                {
                    "checkin_id":431
                    "datetime":"2018-01-23 14:12:23",
                    "checkined":75,
                    "uncheckined":9
                }
            ]
        }
        ```


点击某一条信息进入具体签到结果

+ request

    页面 GET /courses/{course_id}/checkin_history/{checkin_id}

    + HEADERS

        Cookie:key=3w4e5r6tyuifcgvhbjnkmlvg

+ response

    + 200 成功获取签到人员名单列表

    ```
    {
        "checkin":[
            {
                "student_id":"15331689",
                "student_name":"王同学"
            },
            {
                "student_id":"15457682",
                "student_name":"李同学"
            }
        ]
        "uncheckin":[
            {
                "student_id":"15331117",
                "student_name":"黄楠绚"
            },
            {
                "student_id":"15453682",
                "student_name":"贾同学"
            }
        ]
    }
    ```   


### 5.选择某个课程的发起签到

获取二维码签到页面

+ request

    页面 GET /course_checkin?{course_id}

    + HEADERS

        Cookie:key=3w4e5r6tyuifcgvhbjnkmlvg

签到页面有：

    + 会判断是否当前课程是否有【未结束】的二维码签到，有则返回为结束的二维码图片，无则后台调用api根据【course_id+当前时间】=>【hash字符串】生成一个二维码图片，返回给前端页面，半小时内无效(待定)

        - response
            
            获取二维码图片，添加签到记录

    + 学生扫二维码获取的页面：GET /checkinByQRCode?id=hash字符串
        
        输入：姓名+学号
        api: POST /api/checkinByQRCode/{id}
        + request
            + Body
            ```
            {
                "student_id":"15331117",
                "student_name":"王小明",
                "mac":"EW:QW:WD:WI:EW",(待定)
                "ip":"192.168.10.10"（待定）
            }
            ```
        + response
            + 201 课程存在&&学生信息正确&&学生在课程中&&签到未结束  签到成功
                前端显示签到成功
            + 400 "您不在此课程中"（学生不在课程中）|| "签到失败"
                + Body
                ```
                {
                    "message":"xxxx"
                }
                ```
    + 实时查看签到
    
    api: GET api/checkinByQRCode/{id}
    - request
        + HEADERS

            Cookie:key=3w4e5r6tyuifcgvhbjnkmlvg

    - response
        返回当前签到人数
        ```
        {
            "checkined":80
        }
        ```

    + 点击结束签到

    api: DELETE api/checkinByQRCode/{id}
    - request
        + HEADERS

            Cookie:key=3w4e5r6tyuifcgvhbjnkmlvg

    - response
        + 302 跳转到当次签到结果页面



### 6.教师修改密码

获取修改密码页面：GET  /users_password/{user_id}

旧密码 新密码 确定密码
【前端需要检查做新密码两次输入是否一致、检查是否输入为空】

PUT  api/user/password
- request
    + HEADERS

        Cookie:key=3w4e5r6tyuifcgvhbjnkmlvg
    
    + Body
    ```
    {
        "old_password":"qwrtfyh",
        "password":"xxxxxx"
    }
    ```

- response
    + 201 修改成功

    + 400 修改失败  密码错误或新密码长度格式
    ```
    {
        "message":"dwedw"
    }
    ```


### 之前讨论的逻辑

教师：
选择课程

> 某课程主页 显示【课程信息】
 查看信息（课程成员、签到信息） 发起签到 课程列表 课程主页
 (右上角)修改密码 退出登录

> 课程成员
学号 姓名 

> 签到信息

列表 行：时间 签到人数 未签到人数（页面或弹框）
    >显示该课程的某次签到结果
    两列：已签到学生（姓名 学号）未签到学生（姓名 学号）

> 发起签到
二维码 查看目前签到情况 停止签到

> 修改密码
    旧密码 新密码 确定
    【前端需要检查做新密码两次输入是否一致】

管理员：
>  添加全级学生
【添加教师 > 添加课程】
